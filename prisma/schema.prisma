generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

enum LeadSearchStatus {
  PENDING
  RUNNING
  DONE
  DONE_NO_RESULTS
  FAILED
}

enum LeadSearchRunStatus {
  RUNNING
  SUCCESS
  FAILED
}

enum LeadProvider {
  SCRAPER_CITY
  SEARCH_LEADS
  BOOMERANG
  DADDY_LEADS
  APIFY
  SCRUPP
}

enum LeadOrigin {
  PROVIDER
  MANUAL
  CSV_IMPORT
}

enum LeadListStatus {
  NEW
  CONTACTED
  REPLIED
}

enum UserRole {
  ADMIN
  SALE_MANAGER
}

enum LeadSearchKind {
  LEAD_DB
  SCRAPER
}

enum ChatMessageRole {
  USER
  ASSISTANT
  SYSTEM
}

enum ChatMessageType {
  TEXT
  JSON
  EVENT
}

model User {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  email        String    @unique
  passwordHash String
  role         UserRole  @default(SALE_MANAGER)
  isActive     Boolean   @default(true)
  lastLoginAt  DateTime?

  leadSearchesCreated     LeadSearch[]    @relation("LeadSearchCreatedBy")
  leadSearchRunsTriggered LeadSearchRun[] @relation("LeadSearchRunTriggeredBy")

  leadsCreated    Lead[]           @relation("LeadCreatedBy")
  leadSearchLeads LeadSearchLead[]
  chatFolders     ChatFolder[]     @relation("ChatFolderOwner")
  chatThreads     ChatThread[]     @relation("ChatThreadOwner")
  chatMessages    ChatMessage[]    @relation("ChatMessageAuthor")

  @@index([role])
  @@index([isActive])
}

model LeadSearch {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  createdById String
  createdBy   User   @relation("LeadSearchCreatedBy", fields: [createdById], references: [id])

  provider LeadProvider
  kind     LeadSearchKind

  capability LeadProviderCapability @relation(fields: [provider, kind], references: [provider, kind])

  threadId String?
  thread   ChatThread? @relation(fields: [threadId], references: [id], onDelete: SetNull)

  prompt String?
  query  Json
  limit  Int

  status       LeadSearchStatus @default(PENDING)
  totalLeads   Int?
  errorMessage String?

  runs         LeadSearchRun[]
  leads        LeadSearchLead[]
  chatMessages ChatMessage[]

  @@index([createdById])
  @@index([status])
  @@index([threadId])
  @@index([provider, kind])
}

model LeadSearchRun {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  leadSearchId String
  leadSearch   LeadSearch @relation(fields: [leadSearchId], references: [id], onDelete: Cascade)

  provider LeadProvider
  attempt  Int          @default(1)

  triggeredById String?
  triggeredBy   User?   @relation("LeadSearchRunTriggeredBy", fields: [triggeredById], references: [id])

  status       LeadSearchRunStatus @default(RUNNING)
  errorMessage String?

  leadsCount    Int?
  externalRunId String?

  requestPayload Json?
  responseMeta   Json?

  results LeadSearchRunResult[]

  @@unique([leadSearchId, provider, attempt])
  @@index([leadSearchId])
  @@index([provider, status])
  @@index([triggeredById])
}

model Lead {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  origin LeadOrigin @default(PROVIDER)

  createdById String?
  createdBy   User?   @relation("LeadCreatedBy", fields: [createdById], references: [id])

  fullName      String?
  firstName     String?
  lastName      String?
  title         String?
  company       String?
  companyDomain String?
  companyUrl    String?
  linkedinUrl   String?
  location      String?
  email         String?

  meta Json?

  providerRefs LeadProviderRef[]
  searches     LeadSearchLead[]
  runResults   LeadSearchRunResult[]

  @@unique([email])
  @@unique([linkedinUrl])
  @@index([email])
  @@index([linkedinUrl])
  @@index([companyDomain])
}

model LeadProviderRef {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  provider   LeadProvider
  externalId String

  leadId String
  lead   Lead   @relation(fields: [leadId], references: [id], onDelete: Cascade)

  @@unique([provider, externalId])
  @@index([leadId])
}

model LeadSearchLead {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  leadSearchId String
  leadSearch   LeadSearch @relation(fields: [leadSearchId], references: [id], onDelete: Cascade)

  leadId String
  lead   Lead   @relation(fields: [leadId], references: [id], onDelete: Cascade)

  status LeadListStatus @default(NEW)
  notes  String?

  assignedToId String?
  assignedTo   User?   @relation(fields: [assignedToId], references: [id])

  @@unique([leadSearchId, leadId])
  @@index([leadSearchId, status])
  @@index([assignedToId])
}

model LeadSearchRunResult {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())

  runId String
  run   LeadSearchRun @relation(fields: [runId], references: [id], onDelete: Cascade)

  leadId String
  lead   Lead   @relation(fields: [leadId], references: [id], onDelete: Cascade)

  provider           LeadProvider
  providerExternalId String?

  raw Json?

  @@unique([runId, leadId])
  @@index([runId])
  @@index([leadId])
  @@index([provider, providerExternalId])
}

model LeadProviderCapability {
  provider LeadProvider
  kind     LeadSearchKind

  label        String?
  description  String?
  leadSearches LeadSearch[]

  @@id([provider, kind])
}

model ChatFolder {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  ownerId String
  owner   User   @relation("ChatFolderOwner", fields: [ownerId], references: [id], onDelete: Cascade)

  name String

  threads ChatThread[]

  @@unique([ownerId, name])
  @@index([ownerId])
}

model ChatThread {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  ownerId String
  owner   User   @relation("ChatThreadOwner", fields: [ownerId], references: [id], onDelete: Cascade)

  folderId String?
  folder   ChatFolder? @relation(fields: [folderId], references: [id], onDelete: SetNull)

  title String?

  defaultProvider LeadProvider?
  defaultKind     LeadSearchKind?

  lastMessageAt DateTime?
  meta          Json?

  messages     ChatMessage[]
  leadSearches LeadSearch[]

  @@index([ownerId, updatedAt])
  @@index([folderId])
}

model ChatMessage {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  threadId String
  thread   ChatThread @relation(fields: [threadId], references: [id], onDelete: Cascade)

  role ChatMessageRole
  type ChatMessageType @default(TEXT)

  authorUserId String?
  authorUser   User?   @relation("ChatMessageAuthor", fields: [authorUserId], references: [id], onDelete: SetNull)

  text    String?
  payload Json?

  leadSearchId String?
  leadSearch   LeadSearch? @relation(fields: [leadSearchId], references: [id], onDelete: SetNull)

  @@index([threadId, createdAt])
  @@index([authorUserId])
  @@index([leadSearchId])
}
